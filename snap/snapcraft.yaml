name: multipass
version: '2017.0.0'
version-script: |
  git describe
summary: Ubuntu at your fingertips
description: |
  Multipass gives you Ubuntu VMs in seconds. Just run `multipass launch`
  and it'll do all the setup for you. Check out `multipass find` for a list
  of available images. More details you can find under `multipass help`.

grade: devel
confinement: classic

apps:
  multipassd:
    command: bin/launch-multipassd
    environment:
      LD_LIBRARY_PATH: $SNAP/lib/x86_64-linux-gnu:$SNAP/usr/lib/x86_64-linux-gnu::$SNAP/lib:$SNAP/usr/lib:$SNAP/lib/x86_64-linux-gnu:$SNAP/usr/lib/x86_64-linux-gnu
      PATH: $SNAP/usr/sbin:$SNAP/usr/bin:$SNAP/sbin:$SNAP/bin:$PATH
      QT_PLUGIN_PATH: $SNAP/usr/lib/x86_64-linux-gnu/qt5/plugins
      XDG_DATA_HOME: $SNAP_COMMON/data
      XDG_CACHE_HOME: $SNAP_COMMON/cache
    daemon: simple
  multipass:
    environment:
      LD_LIBRARY_PATH: $SNAP/lib/x86_64-linux-gnu:$SNAP/usr/lib/x86_64-linux-gnu::$SNAP/lib:$SNAP/usr/lib:$SNAP/lib/x86_64-linux-gnu:$SNAP/usr/lib/x86_64-linux-gnu
      PATH: $SNAP/usr/sbin:$SNAP/usr/bin:$SNAP/sbin:$SNAP/bin:$PATH
      QT_PLUGIN_PATH: $SNAP/usr/lib/x86_64-linux-gnu/qt5/plugins
    command: bin/multipass
    completer: etc/bash_completion.d/snap.multipass

parts:
  qtbase5-dev:
    after: [qt5-qmake-bin]
    plugin: dump
    source: http://archive.ubuntu.com/ubuntu/pool/main/q/qtbase-opensource-src/qtbase5-dev_5.9.4+dfsg-0ubuntu3_amd64.deb
    source-type: deb
    source-checksum: sha256/50378399c9081eedf967b3ceb939607261d95c240aed224c16e4e6c1e30e4033
    prime: [-*]

  qtbase5-dev-tools:
    plugin: dump
    source: http://archive.ubuntu.com/ubuntu/pool/main/q/qtbase-opensource-src/qtbase5-dev-tools_5.9.4+dfsg-0ubuntu3_amd64.deb
    source-type: deb
    source-checksum: sha256/7b2e5d9a999bc62f4ec228bf1f391e7354aaca49cf966f0324772f4f84febba5
    prime: [-*]

  qt5-qmake:
    plugin: dump
    source: http://archive.ubuntu.com/ubuntu/pool/main/q/qtbase-opensource-src/qt5-qmake_5.9.4+dfsg-0ubuntu3_amd64.deb
    source-type: deb
    source-checksum: sha256/10fd0f3565187e473874857a67f7cadc2acabe4d5bcfe9a99b216f8bc57d586c
    prime: [-*]

  qt5-qmake-bin:
    after: [qt5-qmake]
    plugin: dump
    source: http://archive.ubuntu.com/ubuntu/pool/main/q/qtbase-opensource-src/qt5-qmake-bin_5.9.4+dfsg-0ubuntu3_amd64.deb
    source-type: deb
    source-checksum: sha256/80e4b3bf8ba9cfe9fe4a1cdf8a25d47862871eb8f84b84ab0dc38121f82ca6f5
    prime: [-*]

  libqt5core5a:
    after: [libicu]
    plugin: dump
    source: http://archive.ubuntu.com/ubuntu/pool/main/q/qtbase-opensource-src/libqt5core5a_5.9.4+dfsg-0ubuntu3_amd64.deb
    source-type: deb
    source-checksum: sha256/7817ac47455ae752039239a03d3c31f3182306be29fe9304ea2a508cd6ae573b
    stage-packages:
    - libdouble-conversion1v5
    - libpcre16-3

  libqt5dbus5:
    plugin: dump
    source: http://archive.ubuntu.com/ubuntu/pool/main/q/qtbase-opensource-src/libqt5dbus5_5.9.4+dfsg-0ubuntu3_amd64.deb
    source-type: deb
    source-checksum: sha256/3d2407410f8b2cb7cab92ea5a02a0c5b00584fe0931b11e01b28aa5945db1b5d

  libqt5network5:
    plugin: dump
    source: http://archive.ubuntu.com/ubuntu/pool/main/q/qtbase-opensource-src/libqt5network5_5.9.4+dfsg-0ubuntu3_amd64.deb
    source-type: deb
    source-checksum: sha256/b430549afbc970a86e87477f4ee55c89836ee1ea22f27eea6685c73b64faf8a2
    stage-packages:
    - libproxy1v5

  libicu:
    plugin: dump
    source: http://archive.ubuntu.com/ubuntu/pool/main/i/icu/libicu60_60.2-3ubuntu1_amd64.deb
    source-type: deb
    source-checksum: sha256/3bd30b5935b2a91f10e532da52ffe4011695f69dc264e531a0a094fac284e89a

  multipass:
    after:
    - qtbase5-dev
    - qtbase5-dev-tools
    - libqt5core5a
    - libqt5network5
    plugin: cmake
    build-packages:
    - build-essential
    - cmake-extras
    - golang
    source: .
    configflags:
    - -DCMAKE_BUILD_TYPE=RelWithDebInfo
    - -DCMAKE_INSTALL_PREFIX=/
    - -DMULTIPASS_ENABLE_TESTS=off
    install: |-
      set -ex
      mkdir -p ${SNAPCRAFT_PART_INSTALL}/etc/bash_completion.d/
      echo 'export PATH="${PATH}:/snap/bin:/var/lib/snapd/snap/bin"' > ${SNAPCRAFT_PART_INSTALL}/etc/bash_completion.d/snap.multipass
      cat ../src/completions/bash/multipass >> ${SNAPCRAFT_PART_INSTALL}/etc/bash_completion.d/snap.multipass

  qemu:
    plugin: nil
    stage-packages:
    - qemu-system-x86
    - qemu-utils
    - libslang2
    organize:
      usr/lib/x86_64-linux-gnu/pulseaudio/libpulsecommon-8.0.so: usr/lib/x86_64-linux-gnu/libpulsecommon-8.0.so
      usr/share/seabios/bios-256k.bin: qemu/bios-256k.bin
      usr/share/seabios/vgabios-stdvga.bin: qemu/vgabios-stdvga.bin
      usr/share/seabios/kvmvapic.bin: qemu/kvmvapic.bin
      usr/lib/ipxe/qemu/efi-virtio.rom: qemu/efi-virtio.rom

  dnsmasq:
    plugin: nil
    stage-packages:
    - dnsmasq

  kvm-support:
    plugin: nil
    stage-packages:
    - msr-tools

  network-utils:
    plugin: nil
    stage-packages:
    - iproute2
    - iputils-ping

  glue:
    plugin: dump
    source: snap
